name: Migration Test (1.8 → 2.x)

on:
  push:
    branches: [main, master]
    paths:
      - 'migrations/**'
      - '.github/workflows/migration-test.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test-migration:
    name: Test Data Preservation (Flarum 1.8 → 2.x)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: curl, dom, gd, json, mbstring, openssl, pdo_mysql, tokenizer, zip, iconv
          tools: composer:v2
          coverage: none

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -uroot -proot -e 'CREATE DATABASE flarum_test;'
          mysql -uroot -proot -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';"

      # ============================================
      # PHASE 1: Install Flarum 1.8 + the-turk/diff
      # ============================================
      - name: Create Flarum 1.8 project
        run: |
          composer create-project flarum/flarum:^1.8 flarum-test --stability=stable --no-interaction

      - name: Create installation config file
        run: |
          cat > flarum-test/install.yaml << 'EOF'
          debug: true
          baseUrl: http://localhost
          databaseConfiguration:
            driver: mysql
            host: localhost
            database: flarum_test
            username: root
            password: root
            prefix: ''
            port: 3306
          adminUser:
            username: admin
            password: password12345678
            email: admin@test.local
          settings:
            forum_title: Test Forum
          EOF

      - name: Install Flarum 1.8
        working-directory: flarum-test
        run: |
          php flarum install --file=install.yaml

      - name: Install the-turk/flarum-diff 1.x
        working-directory: flarum-test
        run: |
          composer require the-turk/flarum-diff:"^1.0" --no-interaction
          php flarum migrate
          php flarum cache:clear

      # ============================================
      # PHASE 2: Create test data (revisions)
      # ============================================
      - name: Create discussion and posts with revisions
        run: |
          mysql -uroot -proot flarum_test << 'EOF'
          -- Create a discussion
          INSERT INTO discussions (id, title, slug, comment_count, participant_count, post_number_index, created_at, user_id, first_post_id, last_post_id)
          VALUES (1, 'Test Discussion', 'test-discussion', 1, 1, 1, NOW(), 1, 1, 1)
          ON DUPLICATE KEY UPDATE title = 'Test Discussion';
          
          -- Create a post
          INSERT INTO posts (id, discussion_id, number, created_at, user_id, type, content, edited_at, edit_count)
          VALUES (1, 1, 1, NOW(), 1, 'comment', '<t><p>Current content - revision 3</p></t>', NOW(), 3)
          ON DUPLICATE KEY UPDATE content = '<t><p>Current content - revision 3</p></t>';
          
          -- Create revision history (simulating 3 edits)
          INSERT INTO post_edit_histories (id, post_id, actor_id, revision, created_at, content)
          VALUES 
            (1, 1, 1, 0, DATE_SUB(NOW(), INTERVAL 3 HOUR), 'Original content - revision 0'),
            (2, 1, 1, 1, DATE_SUB(NOW(), INTERVAL 2 HOUR), 'First edit - revision 1'),
            (3, 1, 1, 2, DATE_SUB(NOW(), INTERVAL 1 HOUR), 'Second edit - revision 2')
          ON DUPLICATE KEY UPDATE content = VALUES(content);
          EOF

      - name: Verify test data created
        run: |
          echo "=== Checking post_edit_histories table ==="
          REVISION_COUNT=$(mysql -uroot -proot -N -e "SELECT COUNT(*) FROM flarum_test.post_edit_histories")
          echo "Revision count: $REVISION_COUNT"
          
          echo "=== Revision contents ==="
          mysql -uroot -proot -e "SELECT id, post_id, revision, LEFT(content, 50) as content_preview FROM flarum_test.post_edit_histories"
          
          echo "=== Migration records for the-turk-diff ==="
          mysql -uroot -proot -e "SELECT * FROM flarum_test.migrations WHERE extension = 'the-turk-diff'"
          
          if [ "$REVISION_COUNT" -ne "3" ]; then
            echo "ERROR: Expected 3 revisions, got $REVISION_COUNT"
            exit 1
          fi

      # ============================================
      # PHASE 3: Upgrade to Flarum 2.x
      # ============================================
      - name: Remove the-turk/flarum-diff
        working-directory: flarum-test
        run: |
          composer remove the-turk/flarum-diff --no-interaction

      - name: Upgrade to Flarum 2.x
        working-directory: flarum-test
        run: |
          composer require flarum/core:"^2.0" --no-interaction --with-all-dependencies
          php flarum migrate
          php flarum cache:clear

      - name: Verify data still exists after Flarum upgrade
        run: |
          echo "=== Checking data after Flarum 2.x upgrade ==="
          REVISION_COUNT=$(mysql -uroot -proot -N -e "SELECT COUNT(*) FROM flarum_test.post_edit_histories")
          echo "Revision count after Flarum upgrade: $REVISION_COUNT"
          
          if [ "$REVISION_COUNT" -ne "3" ]; then
            echo "ERROR: Data lost during Flarum upgrade! Expected 3, got $REVISION_COUNT"
            exit 1
          fi
          
          echo "✓ Data preserved after Flarum upgrade"

      # ============================================
      # PHASE 4: Install huseyinfiliz/flarum-diff
      # ============================================
      - name: Install huseyinfiliz/flarum-diff
        working-directory: flarum-test
        run: |
          composer config repositories.local '{"type": "path", "url": "../", "options": {"symlink": false}}'
          composer require huseyinfiliz/flarum-diff:"*" --no-interaction

      - name: Run migrations for huseyinfiliz/flarum-diff
        working-directory: flarum-test
        run: |
          echo "=== Before migration ==="
          mysql -uroot -proot -e "SELECT * FROM flarum_test.migrations WHERE extension LIKE '%diff%'"
          
          php flarum migrate
          php flarum cache:clear
          
          echo "=== After migration ==="
          mysql -uroot -proot -e "SELECT * FROM flarum_test.migrations WHERE extension LIKE '%diff%'"

      # ============================================
      # PHASE 5: Verify data preservation
      # ============================================
      - name: Verify revision data preserved
        run: |
          echo "============================================"
          echo "  FINAL VERIFICATION - DATA PRESERVATION"
          echo "============================================"
          
          REVISION_COUNT=$(mysql -uroot -proot -N -e "SELECT COUNT(*) FROM flarum_test.post_edit_histories")
          echo "Final revision count: $REVISION_COUNT"
          
          echo ""
          echo "=== All revision records ==="
          mysql -uroot -proot -e "SELECT id, post_id, revision, created_at, LEFT(content, 50) as content_preview FROM flarum_test.post_edit_histories ORDER BY revision"
          
          echo ""
          echo "=== Migration records ==="
          mysql -uroot -proot -e "SELECT * FROM flarum_test.migrations WHERE extension LIKE '%diff%' ORDER BY migration"
          
          # Verify specific content exists
          ORIGINAL=$(mysql -uroot -proot -N -e "SELECT content FROM flarum_test.post_edit_histories WHERE revision = 0")
          REV1=$(mysql -uroot -proot -N -e "SELECT content FROM flarum_test.post_edit_histories WHERE revision = 1")
          REV2=$(mysql -uroot -proot -N -e "SELECT content FROM flarum_test.post_edit_histories WHERE revision = 2")
          
          echo ""
          echo "=== Content verification ==="
          echo "Revision 0: $ORIGINAL"
          echo "Revision 1: $REV1"
          echo "Revision 2: $REV2"
          
          # Final assertions
          PASS=true
          
          if [ "$REVISION_COUNT" -ne "3" ]; then
            echo "❌ FAIL: Expected 3 revisions, got $REVISION_COUNT"
            PASS=false
          else
            echo "✓ PASS: Revision count correct (3)"
          fi
          
          if [[ "$ORIGINAL" != *"Original content"* ]]; then
            echo "❌ FAIL: Original content not found"
            PASS=false
          else
            echo "✓ PASS: Original content preserved"
          fi
          
          if [[ "$REV1" != *"First edit"* ]]; then
            echo "❌ FAIL: Revision 1 content not found"
            PASS=false
          else
            echo "✓ PASS: Revision 1 preserved"
          fi
          
          if [[ "$REV2" != *"Second edit"* ]]; then
            echo "❌ FAIL: Revision 2 content not found"
            PASS=false
          else
            echo "✓ PASS: Revision 2 preserved"
          fi
          
          echo ""
          echo "============================================"
          if [ "$PASS" = true ]; then
            echo "  ✅ ALL TESTS PASSED - DATA PRESERVED"
            echo "============================================"
          else
            echo "  ❌ TESTS FAILED - DATA LOSS DETECTED"
            echo "============================================"
            exit 1
          fi

  # Test clean installation (no previous data)
  test-clean-install:
    name: Test Clean Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: curl, dom, gd, json, mbstring, openssl, pdo_mysql, tokenizer, zip, iconv
          tools: composer:v2
          coverage: none

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -uroot -proot -e 'CREATE DATABASE flarum_clean;'
          mysql -uroot -proot -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';"

      - name: Create Flarum 2.x project
        run: |
          composer create-project flarum/flarum:^2.0 flarum-clean --stability=stable --no-interaction

      - name: Create installation config file
        run: |
          cat > flarum-clean/install.yaml << 'EOF'
          debug: true
          baseUrl: http://localhost
          databaseConfiguration:
            driver: mysql
            host: localhost
            database: flarum_clean
            username: root
            password: root
            prefix: ''
            port: 3306
          adminUser:
            username: admin
            password: password12345678
            email: admin@test.local
          settings:
            forum_title: Test Forum Clean
          EOF

      - name: Install Flarum 2.x
        working-directory: flarum-clean
        run: |
          php flarum install --file=install.yaml

      - name: Install huseyinfiliz/flarum-diff (clean)
        working-directory: flarum-clean
        run: |
          composer config repositories.local '{"type": "path", "url": "../", "options": {"symlink": false}}'
          composer require huseyinfiliz/flarum-diff:"*" --no-interaction
          php flarum migrate
          php flarum cache:clear

      - name: Verify tables created correctly
        run: |
          echo "=== Checking tables exist ==="
          
          TABLES=$(mysql -uroot -proot -N -e "SHOW TABLES FROM flarum_clean LIKE 'post_edit_histories%'")
          echo "Tables found:"
          echo "$TABLES"
          
          if echo "$TABLES" | grep -q "post_edit_histories"; then
            echo "✓ post_edit_histories table exists"
          else
            echo "❌ post_edit_histories table missing"
            exit 1
          fi
          
          if echo "$TABLES" | grep -q "post_edit_histories_archive"; then
            echo "✓ post_edit_histories_archive table exists"
          else
            echo "❌ post_edit_histories_archive table missing"
            exit 1
          fi
          
          echo ""
          echo "=== Table structures ==="
          mysql -uroot -proot -e "DESCRIBE flarum_clean.post_edit_histories"
          mysql -uroot -proot -e "DESCRIBE flarum_clean.post_edit_histories_archive"
          
          echo ""
          echo "=== Migration records ==="
          mysql -uroot -proot -e "SELECT * FROM flarum_clean.migrations WHERE extension LIKE '%diff%'"
          
          echo ""
          echo "✅ Clean installation successful"