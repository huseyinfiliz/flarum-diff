(()=>{var t={n:e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return t.d(i,{a:i}),i},d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.reg.get("core","common/extend"),i=flarum.reg.get("core","forum/app");var s=t.n(i);const o=flarum.reg.get("core","forum/components/CommentPost");var r=t.n(o);const n=flarum.reg.get("core","common/components/Page");var a=t.n(n);const l=flarum.reg.get("core","common/models/Post");var d=t.n(l);const f=flarum.reg.get("core","common/Model");var c=t.n(f);const u=flarum.reg.get("core","common/utils/mixin");var h=t.n(u);class p extends(h()(c(),{revision:c().attribute("revision"),createdAt:c().attribute("createdAt",c().transformDate),deletedAt:c().attribute("deletedAt",c().transformDate),rollbackedAt:c().attribute("rollbackedAt",c().transformDate),actor:c().hasOne("actor"),deletedUser:c().hasOne("deletedUser"),rollbackedUser:c().hasOne("rollbackedUser"),inlineHtml:c().attribute("inlineHtml"),sideBySideHtml:c().attribute("sideBySideHtml"),combinedHtml:c().attribute("combinedHtml"),previewHtml:c().attribute("previewHtml"),comparisonBetween:c().attribute("comparisonBetween")})){}flarum.reg.add("huseyinfiliz-diff","forum/models/Diff",p);const v=flarum.reg.get("core","common/components/Dropdown");var g=t.n(v);const w=flarum.reg.get("core","common/app");var b=t.n(w);const y=flarum.reg.get("core","common/Component");var B=t.n(y);const S=flarum.reg.get("core","common/components/Button");var C=t.n(S);const D=flarum.reg.get("core","common/components/Avatar");var I=t.n(D);const N=flarum.reg.get("core","common/components/Icon");var z=t.n(N);const H=flarum.reg.get("core","common/helpers/username");var k=t.n(H);const A=flarum.reg.get("core","common/helpers/humanTime");var M=t.n(A);const x=flarum.reg.get("core","common/utils/extractText");var P=t.n(x);class L extends(C()){view(){const t=Object.assign({},this.attrs);return delete t.item,delete t.subButton,delete t.postDate,t.type="button",m("button",t,this.getButtonContent())}getButtonContent(){const t=this.attrs.item;let e=t.actor(),i=0==t.revision()?P()(app.translator.trans("huseyinfiliz-diff.forum.createdInfo",{username:k()(t.actor()),ago:M()(this.attrs.postDate)})):P()(app.translator.trans("huseyinfiliz-diff.forum.editedInfo",{username:k()(t.actor()),ago:M()(t.createdAt())}));return t.deletedAt()&&(!1===this.attrs.subButton?i=i+" "+app.translator.trans("huseyinfiliz-diff.forum.deletedText"):(e=t.deletedUser(),i=P()(app.translator.trans("huseyinfiliz-diff.forum.deletedInfo",{username:k()(t.deletedUser()),ago:M()(t.deletedAt())})))),[e.username()?m(I(),{user:e}):"",t.deletedAt()&&!1===this.attrs.subButton?m(z(),{name:"fas fa-caret-down",className:"Button-caret"}):"",m("span",{className:"Button-label",title:i},t.deletedAt()&&!0===this.attrs.subButton?m("em",null,i):i)]}}flarum.reg.add("huseyinfiliz-diff","forum/components/DiffButton",L);const O=flarum.reg.get("core","common/components/Modal");var E=t.n(O);const R=flarum.reg.get("core","common/components/Tooltip");var T=t.n(R);function V(t){return t.save({}).then(()=>m.redraw())}flarum.reg.add("huseyinfiliz-diff","forum/utils/redrawPost",V);const U=flarum.reg.get("core","common/components/Alert");var F=t.n(U);const W=flarum.reg.get("core","common/components/LoadingIndicator");var _=t.n(W);class j extends(E()){oninit(t){super.oninit(t),this.loading=!1,this.showing=!1,this.diffId=null,this.comparisonBetween=JSON.parse(this.attrs.listState.selectedItem.comparisonBetween())}className(){return"DiffModal"}title(){return[this.attrs.listState.selectedItem.actor().username()?m(I(),{user:this.attrs.listState.selectedItem.actor()}):"",0!=this.attrs.listState.selectedItem.revision()?b().translator.trans("huseyinfiliz-diff.forum.editedInfo",{username:m("a",{href:b().route.user(this.attrs.listState.selectedItem.actor()),config:m.route},k()(this.attrs.listState.selectedItem.actor())),ago:M()(this.attrs.listState.selectedItem.createdAt())}):b().translator.trans("huseyinfiliz-diff.forum.createdInfo",{username:m("a",{href:b().route.user(this.attrs.listState.selectedItem.actor()),config:m.route},k()(this.attrs.listState.selectedItem.actor())),ago:M()(this.attrs.listState.post.createdAt())})]}oncreate(t){super.oncreate(t),this.config(t)}onupdate(t){this.config(t)}config(t){if(this.showing&&!$(".ModalManager").hasClass("in")&&$(".ModalManager").addClass("in"),this.diffId!==this.attrs.listState.selectedItem.id())return this.showing=!0,this.diffId=this.attrs.listState.selectedItem.id(),this.comparisonBetween=JSON.parse(this.attrs.listState.selectedItem.comparisonBetween()),0!=this.attrs.listState.selectedItem.revision()&&this.comparisonBetween.new.revision!=this.comparisonBetween.old.revision?this.setDiffContent(b().session.user.preferences().diffRenderer?b().session.user.preferences().diffRenderer:"sideBySide"):this.setDiffContent("preview")}view(){return m("div",{className:"Modal modal-dialog "+this.className()},m("div",{className:"Modal-content"},m("div",{className:"Modal-close App-backControl"},C().component({icon:"fas fa-times",onclick:this.hide.bind(this),className:"Button Button--icon Button--link"})),this.attrs.listState.post.canDeleteEditHistory()&&this.attrs.listState.selectedItem.revision()!=this.attrs.listState.post.revisionCount()||this.attrs.listState.post.canRollbackEditHistory()&&this.$(".DeletedDiff").length!=this.attrs.listState.post.revisionCount()?m(g(),{className:"diffCotrollerDropdown App-primaryControl",icon:"fas fa-ellipsis-v",buttonClassName:"Button",menuClassName:"Dropdown-menu--right",label:b().translator.trans("huseyinfiliz-diff.forum.optionsButton")},this.attrs.listState.post.canRollbackEditHistory()&&this.comparisonBetween.old.diffId?C().component({icon:"fas fa-reply",onclick:()=>{if(confirm(b().translator.trans("huseyinfiliz-diff.forum.confirmRollback",{number:this.attrs.listState.selectedItem.revision()}))){this.loading=!0,m.redraw();let t=this.attrs.listState.selectedItem.revision()==this.attrs.listState.post.revisionCount()?this.comparisonBetween.old.diffId:this.attrs.listState.selectedItem.id();b().request({url:"".concat(b().forum.attribute("apiUrl"),"/diff/").concat(t),method:"POST"}).then(()=>{V(this.attrs.listState.post),b().modal.close(),b().cache.diffs&&b().cache.diffs[this.attrs.listState.post.id()]&&delete b().cache.diffs[this.attrs.listState.post.id()],this.showAlert("success","rollback")}).catch(()=>{this.loading=!1,m.redraw(),V(this.attrs.listState.post),this.showAlert("error","rollback")})}}},0==this.attrs.listState.selectedItem.revision()?b().translator.trans("huseyinfiliz-diff.forum.rollbackToOriginalButton"):this.attrs.listState.selectedItem.revision()==this.attrs.listState.post.revisionCount()?0!=this.comparisonBetween.old.revision?b().translator.trans("huseyinfiliz-diff.forum.revertChangesButton"):b().translator.trans("huseyinfiliz-diff.forum.rollbackToOriginalButton"):b().translator.trans("huseyinfiliz-diff.forum.rollbackButton",{number:this.attrs.listState.selectedItem.revision()})):"",this.attrs.listState.post.canDeleteEditHistory()&&this.attrs.listState.selectedItem.revision()!=this.attrs.listState.post.revisionCount()?C().component({icon:"far fa-trash-alt",onclick:()=>{confirm(b().translator.trans("huseyinfiliz-diff.forum.confirmDelete"))&&(this.loading=!0,m.redraw(),this.attrs.listState.selectedItem.delete().then(()=>{b().modal.close(),b().cache.diffs&&b().cache.diffs[this.attrs.listState.post.id()]&&delete b().cache.diffs[this.attrs.listState.post.id()],this.showAlert("success","delete")}).catch(()=>{this.loading=!1,m.redraw(),this.showAlert("error","delete")}))}},b().translator.trans("huseyinfiliz-diff.forum.deleteButton")):""):"",m("div",{className:"Modal-header"},m("h3",{className:"App-titleControl App-titleControl--text"},this.title())),this.content()))}content(){const t=this.attrs.listState.post.revisionCount();return[m("div",{className:"diff-grid"},m("div",{className:"diff-grid-item diff-grid-controls"},m("div",{className:"diffSwitcher"},0!=this.attrs.listState.selectedItem.revision()&&this.comparisonBetween.new.revision!=this.comparisonBetween.old.revision?[{type:"inline",icon:"fas fa-grip-lines",class:"inlineView"},{type:"sideBySide",icon:"fas fa-columns",class:"sideBySideView"},{type:"combined",icon:"far fa-square",class:"combinedView"}].map(t=>m(T(),{showOnFocus:!1,text:b().translator.trans("huseyinfiliz-diff.forum.tooltips.".concat(t.type))},m("div",{className:"tooltip-wrapper"},m(C(),{icon:t.icon,onclick:()=>this.setDiffContent(t.type),className:"Button Button--icon Button--link ".concat(t.class)})))):"",m(T(),{showOnFocus:!1,text:b().translator.trans("huseyinfiliz-diff.forum.tooltips.preview")},m("div",{className:"tooltip-wrapper"},m(C(),{icon:"far fa-eye",onclick:()=>this.setDiffContent("preview"),className:"Button Button--icon Button--link diffPreview"}))))),m("div",{className:"diff-grid-item diff-grid-info"},m("div",{className:"revisionInfo"},m("h4",null,b().translator.trans("huseyinfiliz-diff.forum.revisions",{revisionCount:t})),m("p",{class:"diffInfoContainer"}))),m("div",{className:"diff-grid-item diff-grid-revisions"},m(q,{state:this.attrs.listState})),m("div",{className:"diff-grid-item diff-grid-diff"},m("div",{className:"diffContents"},m("div",{className:"previewContainer Post-body"+(!1===b().forum.attribute("textFormattingForDiffPreviews")?" diff-skip-formatting":"")},this.renderHtml(this.attrs.listState.selectedItem.data.attributes.previewHtml)),m("div",{className:"diffContainer"}))),this.loading?m(_(),{containerClassName:"DiffModal-loading",size:"large"}):"")]}onready(){const t=this.$(".DiffList-content");let e=this.$("li#parentDiff"+this.attrs.listState.selectedItem.id());t.animate({scrollTop:e.offset().top-t.offset().top+t.scrollTop()})}showAlert(t,e){const i={success:"huseyinfiliz-diff.forum."+e+"SuccessMessage",error:"huseyinfiliz-diff.forum."+e+"ErrorMessage"}[t];b().alerts.show(F(),{type:t},b().translator.trans(i))}renderHtml(t){return m.trust(t)}setDiffContent(t){let e;const i=this.$(".diffContainer"),s=this.$(".previewContainer"),o=this.$(".Button.sideBySideView"),r=this.$(".Button.inlineView"),n=this.$(".Button.combinedView"),a=this.$(".Button.diffPreview");return"preview"===t?(i.hide(),this.$(".previewContainer").show(),a.prop("disabled",!0),a.parent().siblings().children().prop("disabled",!1),this.setInfoContent(!0)):("sideBySide"===t?(e=this.renderHtml(this.attrs.listState.selectedItem.data.attributes.sideBySideHtml),o.prop("disabled",!0),o.parent().siblings().children().prop("disabled",!1)):"inline"===t?(e=this.renderHtml(this.attrs.listState.selectedItem.data.attributes.inlineHtml),r.prop("disabled",!0),r.parent().siblings().children().prop("disabled",!1)):"combined"===t&&(e=this.renderHtml(this.attrs.listState.selectedItem.data.attributes.combinedHtml),n.prop("disabled",!0),n.parent().siblings().children().prop("disabled",!1)),e?(i.html(e.children),s.is(":visible")&&(i.show(),s.hide()),b().session.user.savePreferences({diffRenderer:t}),this.setInfoContent()):void 0)}setInfoContent(t){void 0===t&&(t=!1);const e=this.$(".diffInfoContainer");let i=t||0==this.attrs.listState.selectedItem.revision()||this.comparisonBetween.new.revision==this.comparisonBetween.old.revision?P()(b().translator.trans("huseyinfiliz-diff.forum.previewMode.sentence",{content:0==this.comparisonBetween.new.revision?b().translator.trans("huseyinfiliz-diff.forum.previewMode.originalContent"):this.comparisonBetween.new.revision==this.attrs.listState.post.revisionCount()?b().translator.trans("huseyinfiliz-diff.forum.previewMode.currentContent"):b().translator.trans("huseyinfiliz-diff.forum.previewMode.revisionWithNumber",{number:this.comparisonBetween.new.revision})})):P()(b().translator.trans("huseyinfiliz-diff.forum.differences.sentence",{old:-1==this.comparisonBetween.old.revision?b().translator.trans("huseyinfiliz-diff.forum.differences.currentContent"):0==this.comparisonBetween.old.revision?b().translator.trans("huseyinfiliz-diff.forum.differences.originalContent"):b().translator.trans("huseyinfiliz-diff.forum.differences.revisionWithNumber",{number:this.comparisonBetween.old.revision}),new:0==this.comparisonBetween.new.revision?b().translator.trans("huseyinfiliz-diff.forum.differences.originalContent"):this.comparisonBetween.new.revision==this.attrs.listState.post.revisionCount()?b().translator.trans("huseyinfiliz-diff.forum.differences.currentContent"):b().translator.trans("huseyinfiliz-diff.forum.differences.revisionWithNumber",{number:this.comparisonBetween.new.revision})}));return e.html(i)}}flarum.reg.add("huseyinfiliz-diff","forum/components/DiffModal",j);class q extends(B()){view(){const t=this.attrs.state,e=b().cache.diffs[t.post.id()]||[];return m("div",{className:"DiffList-container"},m("div",{className:"DiffList-content"},m("ul",null,e.length?e.map(e=>e.map(e=>{const i="diffListTooltip";let s=m(T(),{showOnFocus:!1,position:"left",text:e.revision()==t.post.revisionCount()?b().translator.trans("huseyinfiliz-diff.forum.tooltips.mostRecent"):0==e.revision()?b().translator.trans("huseyinfiliz-diff.forum.tooltips.originalContent"):b().translator.trans("huseyinfiliz-diff.forum.tooltips.revisionWithNumber",{number:e.revision()})},L.component({"data-container":"body",postDate:t.post.createdAt(),subButton:!1,item:e,onclick:()=>{if(e.deletedAt())this.toggleSubDiff(e.id());else if($("."+i).remove(),t.selectedItem=e,b().modal.show(j,{listState:t}),t.forModal){const t=this.$("li#parentDiff"+e.id());t.find("button").prop("disabled",!0),t.siblings().find("button").prop("disabled",!1),t.siblings().removeClass("active"),t.addClass("active")}},oncreate:t=>{$(t.dom).data("bs.tooltip").tip().addClass(e.deletedAt()?i+" deletedDiffTooltip":i)}}));return[m("li",{className:"Diff ParentDiff"+(e.deletedAt()?" DeletedDiff":""),id:"parentDiff"+e.id()},s),e.deletedAt()?m("li",{className:"Diff SubDiff",id:"subDiff"+e.id()},m(L,{postDate:t.post.createdAt(),subButton:!0,item:e})):""]})):"",t.loading?_().component({className:"LoadingIndicator--block"}):e.length?"":m("div",{className:"DiffList-empty"},b().translator.trans("huseyinfiliz-diff.forum.emptyText")))))}oncreate(t){super.oncreate(t);const e=this.attrs.state;if(e.forModal&&e.selectedItem){let t=this.$("li#parentDiff"+e.selectedItem);t.find("button").prop("disabled",!0),t.addClass("active")}const i=this.$(".DiffList-content");this.$scrollParent="auto"===i.css("overflow")?i:$(window),this.scrollHandler=()=>{const t=this.$scrollParent.scrollTop(),s=this.$scrollParent.height(),o=this.$scrollParent===i?0:i.offset().top,r=i[0].scrollHeight;e.moreResults&&!e.loading&&t+s>=o+r&&e.loadMore()},this.$scrollParent.on("scroll",this.scrollHandler)}onremove(){this.$scrollParent.off("scroll",this.scrollHandler)}toggleSubDiff(t){const e=this.$("li.Diff#subDiff"+t),i=this.$("li.Diff#parentDiff"+t).find(".icon");e.toggle(),i.hasClass("fa-caret-down")?i.removeClass("fa-caret-down").addClass("fa-caret-up"):i.removeClass("fa-caret-up").addClass("fa-caret-down")}}flarum.reg.add("huseyinfiliz-diff","forum/components/DiffList",q);class J{constructor(t,e,i,s){this.post=t,this.forModal=e,this.moreResults=i||!1,this.selectedItem=s,this.loading=!1,app.cache.diffs||(app.cache.diffs=[])}load(){if(app.cache.diffs[this.post.id()])return this.redrawList();this.loadMore()}loadMore(){if(this.loading=!0,this.redrawList(),app.cache.diffs[this.post.id()]&&app.cache.diffs[this.post.id()].length==this.post.revisionCount())return;const t=app.cache.diffs[this.post.id()]?{filter:{post_id:this.post.id()},page:{offset:10*app.cache.diffs[this.post.id()].length}}:{filter:{post_id:this.post.id()}};return app.store.find("diff",t).then(this.parseResults.bind(this)).catch(()=>{}).then(()=>{this.loading=!1,this.redrawList()})}parseResults(t){return app.cache.diffs[this.post.id()]=app.cache.diffs[this.post.id()]||[],t.length&&app.cache.diffs[this.post.id()].push(t),this.moreResults=!!t.payload.links.next,t}redrawList(){if(m.redraw(),!this.forModal)return V(this.post)}}flarum.reg.add("huseyinfiliz-diff","forum/states/DiffListState",J);class G extends(g()){static initAttrs(t){t.className="DiffDropdown",t.buttonClassName="Button Button--link",t.menuClassName=t.menuClassName,t.label=app.translator.trans("huseyinfiliz-diff.forum.editedText"),t.icon="fas fa-history",super.initAttrs(t)}oninit(t){super.oninit(t),this.post=this.attrs.post,this.listState=new J(this.post,!1,null)}getButton(){const t=super.getButton();return t.attrs.title=this.attrs.label,t.attrs.onclick=this.onclick.bind(this),t}getButtonContent(){return[m(z(),{name:this.attrs.icon,className:"Button-icon"}),m("span",{className:"Button-label"},this.attrs.label)]}getMenu(){const t=this.attrs.post.revisionCount();return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName},m("div",{className:"DiffList-header"},m("h4",null,app.translator.trans("huseyinfiliz-diff.forum.revisionInfo",{revisionCount:t}))),this.showing?m(q,{state:this.listState}):"")}onclick(){this.listState.load()}}flarum.reg.add("huseyinfiliz-diff","forum/components/DiffDropdown",G),s().initializers.add("huseyinfiliz-diff",()=>{s().store.models.diff=p,d().prototype.revisionCount=c().attribute("revisionCount"),d().prototype.canViewEditHistory=c().attribute("canViewEditHistory"),d().prototype.canRollbackEditHistory=c().attribute("canRollbackEditHistory"),d().prototype.canDeleteEditHistory=c().attribute("canDeleteEditHistory"),(0,e.extend)(r().prototype,"headerItems",function(t){const e=this.attrs.post;e.isEdited()&&!e.isHidden()&&e.canViewEditHistory()&&e.revisionCount()>0&&(t.has("edited")&&t.remove("edited"),t.add("edited",m(G,{post:e}))),this.isEditing()&&s().cache.diffs&&s().cache.diffs[this.attrs.post.id()]&&delete s().cache.diffs[this.attrs.post.id()]}),(0,e.extend)(a().prototype,"oninit",function(){$("body").on("click","li.ParentDiff.DeletedDiff, li.SubDiff",function(t){t.stopPropagation()})})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map